<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Choix exercices - {{ pattern_name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .center { text-align:center; margin-top:20px; }
    .exercise-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:14px; align-items:start; max-width:980px; margin: 0 auto; }
    .exercise { box-sizing:border-box; padding:8px; text-align:center; border-radius:8px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.2s; }
    .exercise:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    img.thumb { width:100%; height:140px; object-fit:cover; border-radius:6px; display:block; margin: 0 auto 8px; }
    .note { font-size:0.9em; color:#666 }
    .exercise.selected { outline: 3px solid #0072CE; background:#E8F4FD }
    .badge { position:relative; display:inline-block; }
    .badge .count { position:absolute; top:6px; right:6px; background:#0072CE; color:#fff; font-weight:700; border-radius:10px; padding:2px 6px; font-size:12px; }
    .counter { margin-top:12px; font-weight:600 }
    .validate-btn { 
      display: inline-block;
      margin-top: 20px;
      padding: 12px 32px;
      background: #0072CE;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,114,206,0.2);
    }
    .validate-btn:hover { 
      background: #005AA3;
      box-shadow: 0 4px 8px rgba(0,114,206,0.3);
      transform: translateY(-1px);
    }
    .validate-btn:active {
      transform: translateY(0);
    }
    .validate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div>
        <div class="app-title">MyTrainingPal</div>
        <div class="app-sub">Sélection des exercices — {{ pattern_name }}</div>
      </div>
      <div class="topbar"><a class="reset-btn" href="{{ url_for('reset') }}">Reset</a></div>
    </header>

    <div class="card">
      <h2 class="center">{{ pattern_name }}</h2>
      <p class="note center">Choisissez 1 ou 2 exercices pour ce pattern</p>
      <form method="post">
        <div class="exercise-grid">
      {% for name, path in exercises %}
        <div class="exercise" data-idx="{{ loop.index0 }}">
          <div class="badge">
            {% if path %}
              <img class="thumb" src="{{ url_for('media', path=path) }}" alt="{{ name }}">
            {% else %}
              <div style="height:140px;display:flex;align-items:center;justify-content:center;background:#f2f2f2;border-radius:6px;color:#888">No image</div>
            {% endif %}
            <span class="count" style="display:none">0</span>
          </div>
          <div>{{ name }}</div>
        </div>
      {% endfor %}
      </div>

        </div>

        <div style="clear:both"></div>
        <div class="counter center">Sélections: <span id="click-count">0</span>/2</div>
        <div class="center">
          <button type="submit" class="validate-btn" id="validate-btn" disabled>Valider</button>
        </div>

      <!-- JS to register clicks (allows choosing 1 or 2 exercises, click again to deselect) -->
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const form = document.querySelector('form');
          const exerciseEls = Array.from(document.querySelectorAll('.exercise'));
          const validateBtn = document.getElementById('validate-btn');
          const hiddenContainer = document.createElement('div');
          hiddenContainer.style.display = 'none';
          form.appendChild(hiddenContainer);

          const counterDisplay = document.getElementById('click-count');
          
          // Track selection count for each exercise by index
          const selectionCounts = {};

          function getTotalSelections() {
            return Object.values(selectionCounts).reduce((sum, count) => sum + count, 0);
          }

          function updateValidateButton() {
            // Enable button if at least 1 exercise is selected
            const total = getTotalSelections();
            validateBtn.disabled = total < 1 || total > 2;
          }

          function updateBadge(el, count) {
            const badge = el.querySelector('.count');
            if (!badge) return;
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
            if (count > 0) {
              el.classList.add('selected');
            } else {
              el.classList.remove('selected');
            }

            // trigger a pulse animation on the badge when it changes
            badge.classList.remove('pulse');
            void badge.offsetWidth;
            badge.classList.add('pulse');
            badge.addEventListener('animationend', function () { badge.classList.remove('pulse'); }, { once: true });
          }

          function updateHiddenInputs() {
            // Clear all hidden inputs
            hiddenContainer.innerHTML = '';
            
            // Add hidden inputs for each selection
            for (const [idx, count] of Object.entries(selectionCounts)) {
              for (let i = 0; i < count; i++) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'chosen';
                input.value = idx;
                hiddenContainer.appendChild(input);
              }
            }
          }

          exerciseEls.forEach(function (el) {
            const idx = el.getAttribute('data-idx');
            selectionCounts[idx] = 0;
            
            el.style.cursor = 'pointer';
            el.addEventListener('click', function (e) {
              const currentCount = selectionCounts[idx];
              const totalSelections = getTotalSelections();

              // If clicking on already selected exercise, deselect it
              if (currentCount > 0) {
                selectionCounts[idx] = 0;
              } 
              // If we haven't reached the limit, allow selection
              else if (totalSelections < 2) {
                selectionCounts[idx] = 1;
              }
              // If at limit, don't do anything
              else {
                return;
              }

              // Update UI
              const newCount = selectionCounts[idx];
              updateBadge(el, newCount);
              
              const total = getTotalSelections();
              counterDisplay.textContent = total;
              
              updateHiddenInputs();
              updateValidateButton();
            });
          });

          // Prevent form submission on Enter key (only allow button click)
          form.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
            }
          });
        });
      </script>
    </form>
    <p>Pattern {{ index + 1 }} / {{ total }}</p>
  </div>
</body>
</html>
